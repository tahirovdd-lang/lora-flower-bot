<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>FLORA ‚Äî Premium Catalog</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#fbfbfd;
      --card:#ffffff;
      --text:#121212;
      --muted:#6c6c72;
      --brand:#2aa36b;
      --brand2:#1e7b52;
      --pink:#ff4d8d;
      --gold:#d4a017;
      --line:rgba(0,0,0,.08);
      --shadow: 0 14px 40px rgba(0,0,0,.10);
      --shadow2: 0 10px 22px rgba(0,0,0,.08);
      --r:18px;
      --r2:22px;
      --ease:cubic-bezier(.2,.8,.2,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#ffffff,var(--bg));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1020px;margin:0 auto;padding:14px 14px 110px}
    .top{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);border-radius:var(--r);
      background:rgba(255,255,255,.86);
      backdrop-filter:blur(10px);
      position:sticky;top:10px;z-index:30;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:16px;letter-spacing:.2px}
    .brand span{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center}
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      display:flex;gap:8px;align-items:center;
      background:#fff;
      cursor:pointer;
      user-select:none;
      transition:transform .12s var(--ease);
    }
    .pill:active{transform:scale(.98)}
    .pill b{font-size:13px}
    .iconbtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      transition:transform .12s var(--ease), box-shadow .2s var(--ease);
      display:flex;align-items:center;justify-content:center;
    }
    .iconbtn:active{transform:scale(.98)}
    .muted{color:var(--muted);font-size:12px}

    /* Stories / banners */
    .stories{
      margin-top:12px;
      display:flex;gap:10px;overflow:auto;
      padding-bottom:4px;
      scroll-snap-type:x mandatory;
    }
    .story{
      min-width:260px;
      border-radius:var(--r2);
      border:1px solid var(--line);
      background:linear-gradient(135deg, rgba(42,163,107,.18), rgba(255,77,141,.12));
      box-shadow:var(--shadow2);
      padding:14px;
      scroll-snap-align:start;
      cursor:pointer;
      transition:transform .15s var(--ease);
      position:relative;
      overflow:hidden;
    }
    .story:active{transform:scale(.99)}
    .story .tag{
      position:absolute;top:12px;right:12px;
      font-size:11px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(255,255,255,.55);
      backdrop-filter: blur(8px);
    }
    .story h3{margin:0;font-size:14px;letter-spacing:.2px}
    .story p{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .story .cta{
      margin-top:10px;
      display:inline-flex;gap:8px;align-items:center;
      font-size:12px;font-weight:900;color:var(--brand2);
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(42,163,107,.18);
    }

    /* Grid */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media (min-width:800px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;flex-direction:column;
      min-height:290px;
      transform:translateZ(0);
      transition:transform .18s var(--ease), box-shadow .2s var(--ease);
      position:relative;
    }
    .card:active{transform:scale(.995)}
    .badges{
      position:absolute;top:10px;left:10px;
      display:flex;gap:6px;flex-wrap:wrap;
      z-index:2;
      pointer-events:none;
    }
    .badge{
      font-size:10px;font-weight:950;
      padding:6px 9px;border-radius:999px;
      color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.12);
      letter-spacing:.2px;
    }
    .b-hit{background:linear-gradient(135deg,#ff7a18,#ffb703)}
    .b-new{background:linear-gradient(135deg,#2aa36b,#1e7b52)}
    .b-limited{background:linear-gradient(135deg,#111,#444)}
    .b-season{background:linear-gradient(135deg,#ff4d8d,#ff7aa8)}
    .fav{
      position:absolute;top:10px;right:10px;
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;z-index:3;
      transition:transform .12s var(--ease);
    }
    .fav:active{transform:scale(.98)}
    .fav.on{border-color:rgba(255,77,141,.40)}
    .fav svg{width:18px;height:18px}
    .fav.on svg path{fill:var(--pink);stroke:var(--pink)}
    .fav svg path{fill:transparent;stroke:#444;stroke-width:2}

    /* Image carousel in card */
    .media{
      height:170px;
      position:relative;
      background:linear-gradient(135deg, rgba(42,163,107,.14), rgba(30,123,82,.08));
      overflow:hidden;
      cursor:pointer;
    }
    .track{
      height:100%;
      display:flex;
      transition:transform .28s var(--ease);
      will-change:transform;
    }
    .slide{
      flex:0 0 100%;
      height:170px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#f3f4f6;
    }
    .slide img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transform:scale(1.02);
    }
    .dots{
      position:absolute;left:0;right:0;bottom:10px;
      display:flex;gap:6px;justify-content:center;
      z-index:2;
      pointer-events:none;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.08);
    }
    .dot.on{background:#fff}
    .out{
      position:absolute;left:10px;bottom:10px;
      padding:7px 10px;border-radius:999px;
      background:rgba(17,17,17,.75);
      color:#fff;font-weight:950;font-size:11px;
      z-index:3;
    }

    .cbody{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:950;line-height:1.15;letter-spacing:.2px}
    .meta{display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      font-size:11px;font-weight:900;
      padding:6px 9px;border-radius:999px;
      background:rgba(42,163,107,.10);
      color:var(--brand2);
      border:1px solid rgba(42,163,107,.18);
    }
    .desc{font-size:12px;color:var(--muted);min-height:34px;line-height:1.35}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .price{font-weight:950}
    .btn{
      border:none;border-radius:14px;
      padding:10px 10px;
      font-weight:950;
      cursor:pointer;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;
      transition:transform .12s var(--ease), opacity .2s var(--ease);
    }
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.secondary{
      background:#fff;color:var(--brand2);
      border:1px solid rgba(42,163,107,.30);
    }
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(0,0,0,.10);
      color:#111;
    }

    /* Footerbar */
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 14px;
      background:rgba(255,255,255,.92);
      border-top:1px solid var(--line);
      backdrop-filter:blur(12px);
      z-index:40;
    }
    .footerbar .bar{
      max-width:1020px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .tot{display:flex;flex-direction:column;gap:2px}
    .tot b{font-size:14px}
    .tot span{font-size:12px;color:var(--muted)}

    /* Drawer / Modal base */
    .drawer{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;
      border-top:1px solid var(--line);
      border-radius:20px 20px 0 0;
      box-shadow:0 -18px 60px rgba(0,0,0,.14);
      transform:translateY(110%);
      transition:.25s var(--ease);
      z-index:60;
      max-height:86vh;
      overflow:auto;
    }
    .drawer.open{transform:translateY(0)}
    .dhead{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      position:sticky;top:0;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      z-index:2;
    }
    .dhead b{font-size:16px}
    .close{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--line);background:#fff;cursor:pointer;
      font-size:18px;
    }
    .dcontent{padding:12px 14px 14px}
    .sectionTitle{
      margin:4px 0 8px;
      font-weight:950;
      letter-spacing:.2px;
    }

    .cartitem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 0;border-bottom:1px solid var(--line);
    }
    .cartitem:last-child{border-bottom:none}
    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:999px;padding:6px 8px;
    }
    .qbtn{
      width:28px;height:28px;border-radius:10px;border:none;
      cursor:pointer;font-weight:950;
      background:rgba(42,163,107,.12);color:var(--brand2);
    }

    .form{display:grid;grid-template-columns:1fr;gap:10px}
    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:10px;border:1px solid var(--line);border-radius:16px;
      background:#fff;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input,.field textarea,.field select{
      border:none;outline:none;font-size:14px;
      font-family:inherit;
      resize:none;
      background:transparent;
    }

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .toggle{
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .tbtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:9px 10px;
      font-weight:950;
      cursor:pointer;
      transition:transform .12s var(--ease);
      font-size:12px;
    }
    .tbtn:active{transform:scale(.99)}
    .tbtn.on{
      border-color:rgba(42,163,107,.35);
      background:rgba(42,163,107,.10);
      color:var(--brand2);
    }

    .hr{height:1px;background:var(--line);margin:12px 0}

    /* Product modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition:.2s var(--ease);
      z-index:80;
    }
    .overlay.open{opacity:1;pointer-events:auto}
    .modal{
      position:fixed;left:50%;top:50%;
      transform:translate(-50%,-50%) scale(.98);
      width:min(940px, calc(100vw - 24px));
      max-height:86vh;
      overflow:auto;
      background:#fff;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.6);
      box-shadow:0 30px 90px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:.2s var(--ease);
      z-index:90;
    }
    .modal.open{
      opacity:1;
      pointer-events:auto;
      transform:translate(-50%,-50%) scale(1);
    }
    .mhead{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      position:sticky;top:0;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      z-index:2;
    }
    .mgrid{
      padding:12px 14px 14px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width:860px){
      .mgrid{grid-template-columns:1.2fr .8fr}
    }
    .pmMedia{
      border-radius:22px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#f3f4f6;
      position:relative;
      height:320px;
    }
    .pmMedia img{width:100%;height:100%;object-fit:cover;display:block}
    .pmZoom{
      position:absolute;right:12px;bottom:12px;
      display:flex;gap:8px;
    }
    .zbtn{
      width:42px;height:42px;border-radius:16px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(255,255,255,.78);
      backdrop-filter:blur(10px);
      cursor:pointer;font-weight:950;
    }
    .pmInfo .h{
      font-size:18px;font-weight:1000;letter-spacing:.2px;margin:0 0 6px;
    }
    .pmInfo .p{font-size:12px;color:var(--muted);margin:0 0 10px;line-height:1.45}
    .list{display:flex;flex-direction:column;gap:8px}
    .li{
      padding:10px;border:1px solid var(--line);border-radius:16px;
      background:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .li b{font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .recs{
      display:flex;gap:10px;overflow:auto;padding-bottom:4px;
    }
    .rec{
      min-width:220px;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:var(--shadow2);
      background:#fff;
      cursor:pointer;
    }
    .rec .im{height:120px;background:#eee}
    .rec .im img{width:100%;height:100%;object-fit:cover;display:block}
    .rec .b{padding:10px}
    .rec .b b{display:block;font-size:13px}
    .rec .b span{font-size:12px;color:var(--muted)}

    /* Wizard */
    .stepper{display:flex;gap:8px;flex-wrap:wrap}
    .stepDot{
      width:10px;height:10px;border-radius:999px;background:rgba(0,0,0,.12);
    }
    .stepDot.on{background:rgba(42,163,107,.8)}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:88px;
      transform:translateX(-50%) translateY(20px);
      background:rgba(17,17,17,.88);
      color:#fff;
      padding:10px 12px;border-radius:14px;
      font-size:12px;font-weight:800;
      opacity:0;
      transition:.2s var(--ease);
      z-index:120;
      max-width:calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>FLORA Samarkand</b>
        <span>Premium –±—É–∫–µ—Ç—ã ‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ —Å–ª–æ—Ç–∞–º–∏ ‚Ä¢ ‚Äú–¥–æ—Ä–æ–≥–æ –≤—ã–≥–ª—è–¥–∏—Ç‚Äù</span>
      </div>
      <div class="actions">
        <button class="iconbtn" id="openFilters" title="–§–∏–ª—å—Ç—Ä—ã">‚öôÔ∏è</button>
        <button class="iconbtn" id="openProfile" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
        <div class="pill" id="openCart">
          üõí <b id="cartCount">0</b>
        </div>
      </div>
    </div>

    <div class="stories" id="stories"></div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="footerbar">
    <div class="bar">
      <div class="tot">
        <b id="totalText">–ò—Ç–æ–≥–æ: 0 UZS</b>
        <span id="hintText">–ë—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑ ‚Ä¢ –í –∫–æ—Ä–∑–∏–Ω–µ —Å–ª–æ—Ç—ã/–∑–æ–Ω—ã/–æ–ø–ª–∞—Ç–∞</span>
      </div>
      <button class="btn" id="openCart2">–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>

  <!-- Cart Drawer -->
  <div class="drawer" id="drawer">
    <div class="dhead">
      <b>üõí –ö–æ—Ä–∑–∏–Ω–∞</b>
      <button class="close" id="closeDrawer">‚úï</button>
    </div>
    <div class="dcontent">
      <div id="cartList"></div>

      <div class="hr"></div>

      <div class="row">
        <div class="muted">–¢–æ–≤–∞—Ä—ã</div>
        <div class="price" id="drawerSubtotal">0 UZS</div>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="muted">–î–æ—Å—Ç–∞–≤–∫–∞ (–ø–æ –∑–æ–Ω–µ)</div>
        <div class="price" id="drawerDeliveryFee">0 UZS</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="muted">–ò—Ç–æ–≥–æ</div>
        <div class="price" id="drawerTotal">0 UZS</div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞</div>

      <div class="toggle" style="margin-bottom:10px">
        <button class="tbtn on" id="tDelivery">üöö –î–æ—Å—Ç–∞–≤–∫–∞</button>
        <button class="tbtn" id="tPickup">üè¨ –°–∞–º–æ–≤—ã–≤–æ–∑</button>
      </div>

      <div class="form">
        <div class="field">
          <label>–ò–º—è</label>
          <input id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∞–ª–µ—Ä" />
        </div>

        <div class="field">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phone" placeholder="+998 __ ___ __ __" />
        </div>

        <div class="field" id="addressField">
          <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input id="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –æ—Ä–∏–µ–Ω—Ç–∏—Ä" />
        </div>

        <div class="field" id="zoneField">
          <label>–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <select id="zone"></select>
        </div>

        <div class="two">
          <div class="field">
            <label>–î–∞—Ç–∞</label>
            <input id="date" placeholder="–ù–∞–ø—Ä: 29.01" />
          </div>
          <div class="field">
            <label>–°–ª–æ—Ç –≤—Ä–µ–º–µ–Ω–∏</label>
            <select id="slot"></select>
          </div>
        </div>

        <div class="toggle">
          <button class="tbtn" id="urgentBtn">‚ö° –°—Ä–æ—á–Ω–æ 60‚Äì90 –º–∏–Ω—É—Ç</button>
        </div>

        <div class="field">
          <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–º–∞–º–∞/–ª—é–±–∏–º–∞—è/–¥—Ä—É–≥‚Ä¶)</label>
          <input id="recipient" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–º–∞" />
        </div>

        <div class="field">
          <label>–£–ø–∞–∫–æ–≤–∫–∞</label>
          <select id="wrap">
            <option value="–ö–ª–∞—Å—Å–∏–∫–∞">–ö–ª–∞—Å—Å–∏–∫–∞</option>
            <option value="–ü—Ä–µ–º–∏—É–º (–ª—ë–Ω/—Å–∞—Ç–∏–Ω)">–ü—Ä–µ–º–∏—É–º (–ª—ë–Ω/—Å–∞—Ç–∏–Ω)</option>
            <option value="–ú–∏–Ω–∏–º–∞–ª–∏–∑–º (–∫—Ä–∞—Ñ—Ç)">–ú–∏–Ω–∏–º–∞–ª–∏–∑–º (–∫—Ä–∞—Ñ—Ç)</option>
            <option value="–Ø—Ä–∫–∞—è (–∞–∫—Ü–µ–Ω—Ç)">–Ø—Ä–∫–∞—è (–∞–∫—Ü–µ–Ω—Ç)</option>
          </select>
        </div>

        <div class="field">
          <label>–û—Ç–∫—Ä—ã—Ç–∫–∞ (—Ç–µ–∫—Å—Ç)</label>
          <textarea id="cardText" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—é–±–ª—é —Ç–µ–±—è."></textarea>
        </div>

        <div class="field">
          <label>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
          <select id="payment">
            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–º–∏</option>
            <option value="click">Click</option>
            <option value="card">–ö–∞—Ä—Ç–æ–π</option>
          </select>
        </div>

        <div class="field">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <textarea id="comment" rows="3" placeholder="–¶–≤–µ—Ç —É–ø–∞–∫–æ–≤–∫–∏, –æ—Ä–∏–µ–Ω—Ç–∏—Ä, –ø–æ–∂–µ–ª–∞–Ω–∏—è‚Ä¶"></textarea>
        </div>

        <button class="btn" id="submitOrder">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>

        <div class="two">
          <button class="btn secondary" id="openWizard">üéÅ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±—É–∫–µ—Ç–∞</button>
          <button class="btn secondary" id="clearCart">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>

        <div class="muted" style="padding-top:4px">
          –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑ —É–π–¥—ë—Ç –≤ –±–æ—Ç. –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å.
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Drawer -->
  <div class="drawer" id="filters">
    <div class="dhead">
      <b>‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</b>
      <button class="close" id="closeFilters">‚úï</button>
    </div>
    <div class="dcontent">
      <div class="sectionTitle">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
      <div class="field">
        <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å</label>
        <select id="sort">
          <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
          <option value="fast">–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</option>
          <option value="premium">–ü—Ä–µ–º–∏—É–º</option>
          <option value="under300">–î–æ 300k</option>
          <option value="priceAsc">–¶–µ–Ω–∞ ‚Üë</option>
          <option value="priceDesc">–¶–µ–Ω–∞ ‚Üì</option>
        </select>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">–§–∏–ª—å—Ç—Ä—ã</div>

      <div class="field">
        <label>–¶–µ–Ω–∞ –¥–æ (UZS)</label>
        <input id="priceMax" type="number" placeholder="–ù–∞–ø—Ä: 300000" />
      </div>

      <div class="field">
        <label>–¶–≤–µ—Ç</label>
        <div class="toggle" id="colorChips"></div>
      </div>

      <div class="field">
        <label>–ü–æ–≤–æ–¥</label>
        <div class="toggle" id="occasionChips"></div>
      </div>

      <div class="field">
        <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
        <div class="toggle" id="recipientChips"></div>
      </div>

      <div class="toggle">
        <button class="tbtn" id="fInStock">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏</button>
        <button class="tbtn" id="fFast">‚ö° –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</button>
      </div>

      <div class="hr"></div>

      <div class="two">
        <button class="btn secondary" id="resetFilters">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button class="btn" id="applyFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>

      <div class="muted" style="margin-top:10px">
        –§–∏–ª—å—Ç—Ä—ã —É—Å–∫–æ—Ä—è—é—Ç –≤—ã–±–æ—Ä ‚Üí –º–µ–Ω—å—à–µ ‚Äú—É—à—ë–ª –ø–æ–¥—É–º–∞—Ç—å‚Äù.
      </div>
    </div>
  </div>

  <!-- Profile Drawer -->
  <div class="drawer" id="profile">
    <div class="dhead">
      <b>üë§ –ü—Ä–æ—Ñ–∏–ª—å –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</b>
      <button class="close" id="closeProfile">‚úï</button>
    </div>
    <div class="dcontent">
      <div class="sectionTitle">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="form">
        <div class="field">
          <label>–ò–º—è</label>
          <input id="pName" placeholder="–í–∞—à–µ –∏–º—è" />
        </div>
        <div class="field">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="pPhone" placeholder="+998..." />
        </div>
        <div class="field">
          <label>–ê–¥—Ä–µ—Å–∞ (—á–µ—Ä–µ–∑ ; )</label>
          <input id="pAddresses" placeholder="–î–æ–º‚Ä¶; –†–∞–±–æ—Ç–∞‚Ä¶; ‚Ä¶" />
        </div>
        <div class="field">
          <label>–ß–∞—Å—Ç—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ (—á–µ—Ä–µ–∑ ; )</label>
          <input id="pRecipients" placeholder="–ú–∞–º–∞; –õ—é–±–∏–º–∞—è; –î—Ä—É–≥‚Ä¶" />
        </div>

        <button class="btn" id="saveProfile">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div class="muted">–ü—Ä–æ—Ñ–∏–ª—å —É—Å–∫–æ—Ä—è–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ + –ø–æ–≤—ã—à–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏.</div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
      <div class="form">
        <div class="two">
          <div class="field">
            <label>–ö–æ–º—É</label>
            <input id="rWho" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–º–∞" />
          </div>
          <div class="field">
            <label>–î–∞—Ç–∞ (–î–î.–ú–ú)</label>
            <input id="rDate" placeholder="–ù–∞–ø—Ä: 12.02" />
          </div>
        </div>
        <button class="btn secondary" id="addReminder">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
        <div id="remindersList" class="muted"></div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
      <div id="favList" class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏—Ç–µ ‚ù§Ô∏è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –±—É–∫–µ—Ç–∞.</div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="overlay" id="overlay"></div>
  <div class="modal" id="productModal">
    <div class="mhead">
      <b id="pmTitle">–ë—É–∫–µ—Ç</b>
      <button class="close" id="closeProduct">‚úï</button>
    </div>
    <div class="mgrid">
      <div class="pmMedia" id="pmMedia">
        <img id="pmImg" src="" alt="">
        <div class="pmZoom">
          <button class="zbtn" id="zMinus">‚àí</button>
          <button class="zbtn" id="zPlus">+</button>
        </div>
      </div>
      <div class="pmInfo">
        <h2 class="h" id="pmH"></h2>
        <p class="p" id="pmDesc"></p>

        <div class="list">
          <div class="li">
            <div>
              <b id="pmPrice">0 UZS</b><div class="small" id="pmStock">–í –Ω–∞–ª–∏—á–∏–∏</div>
            </div>
            <button class="btn" id="pmAdd">‚ûï –í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
          <div class="li">
            <div>
              <b>–ü–æ—Ö–æ–∂–∏–µ</b><div class="small">–ø–æ–¥–±–æ—Ä ‚Äú–∫–∞–∫ —É –±–æ–ª—å—à–∏—Ö –±—Ä–µ–Ω–¥–æ–≤‚Äù</div>
            </div>
            <button class="btn ghost" id="pmShowSimilar">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">–ü–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</div>
        <div class="recs" id="pmRecs"></div>
      </div>
    </div>
  </div>

  <!-- Wizard Modal -->
  <div class="overlay" id="wOverlay"></div>
  <div class="modal" id="wizardModal">
    <div class="mhead">
      <b>üéÅ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±—É–∫–µ—Ç–∞</b>
      <button class="close" id="closeWizard">‚úï</button>
    </div>
    <div style="padding:12px 14px 14px">
      <div class="stepper" id="steps"></div>
      <div class="hr"></div>
      <div id="wizBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ</div>

<script>
  // ===== Telegram WebApp init =====
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    tg.ready();
  }

  // ===== Utilities =====
  const CURRENCY = "UZS";
  const LS = {
    profile: "flora_profile_v1",
    favs: "flora_favs_v1",
    reminders: "flora_reminders_v1",
  };

  function money(n){
    n = Math.round(Number(n||0));
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }
  function haptic(){
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  }
  function uid(){
    return Math.random().toString(36).slice(2,9);
  }

  // ===== Data (–∑–∞–º–µ–Ω–∏ —Ñ–æ—Ç–æ –Ω–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ) =====
  const BANNERS = [
    { id:"love", title:"–î–µ–Ω—å –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö", desc:"–†–æ–º–∞–Ω—Ç–∏–∫–∞ + –Ω–µ–∂–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ ‚Ä¢ —Ç–æ–ø –≤—ã–±–æ—Ä–æ–≤", tag:"–°–µ–∑–æ–Ω", filter:{ occasion:"–†–æ–º–∞–Ω—Ç–∏–∫–∞" } },
    { id:"march8", title:"8 –ú–∞—Ä—Ç–∞", desc:"–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–ª–æ—Ç–∞–º–∏ ‚Ä¢ —Ö–∏—Ç—ã –ø—Ä–æ–¥–∞–∂", tag:"–•–∏—Ç", filter:{ occasion:"8 –º–∞—Ä—Ç–∞" } },
    { id:"peony", title:"–°–µ–∑–æ–Ω –ø–∏–æ–Ω–æ–≤", desc:"Limited ‚Ä¢ –ø—Ä–µ–º–∏—É–º –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏", tag:"Limited", filter:{ season:true } },
    { id:"wedding", title:"–°–≤–∞–¥–µ–±–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è", desc:"–ü–æ–¥–±–æ—Ä –ø–æ–¥ –ø–ª–∞—Ç—å–µ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é", tag:"Premium", filter:{ occasion:"–°–≤–∞–¥—å–±–∞" } },
  ];

  const PRODUCTS = [
    {
      id:"rose_25",
      title:"25 –∫—Ä–∞—Å–Ω—ã—Ö —Ä–æ–∑",
      desc:"–ö–ª–∞—Å—Å–∏–∫–∞ –¥–ª—è –æ—Å–æ–±–æ–≥–æ —Å–ª—É—á–∞—è. –ë–æ–≥–∞—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç, —Å–∏–ª—å–Ω—ã–π –≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç.",
      price:350000,
      premium:false,
      popular:98,
      fast:true,
      colors:["–ö—Ä–∞—Å–Ω—ã–π"],
      occasion:["–†–æ–º–∞–Ω—Ç–∏–∫–∞","–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è","8 –º–∞—Ä—Ç–∞"],
      recipient:["–õ—é–±–∏–º–∞—è","–ñ–µ–Ω–∞"],
      tags:["–•–∏—Ç"],
      season:false,
      stock:14,
      images:[
        "https://picsum.photos/seed/rose1/900/700",
        "https://picsum.photos/seed/rose2/900/700",
        "https://picsum.photos/seed/rose3/900/700",
      ],
    },
    {
      id:"mix_pastel",
      title:"–ù–µ–∂–Ω—ã–π –º–∏–∫—Å (–ø–∞—Å—Ç–µ–ª—å)",
      desc:"–í–æ–∑–¥—É—à–Ω—ã–π —Å–±–æ—Ä–Ω—ã–π –±—É–∫–µ—Ç. –û—á–µ–Ω—å —ç—Å—Ç–µ—Ç–∏—á–Ω—ã–π, premium-–æ—â—É—â–µ–Ω–∏–µ.",
      price:280000,
      premium:true,
      popular:84,
      fast:true,
      colors:["–ë–µ–ª—ã–π","–†–æ–∑–æ–≤—ã–π"],
      occasion:["–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è","–†–æ–º–∞–Ω—Ç–∏–∫–∞"],
      recipient:["–ú–∞–º–∞","–õ—é–±–∏–º–∞—è","–ü–æ–¥—Ä—É–≥–∞"],
      tags:["–ù–æ–≤–∏–Ω–∫–∞"],
      season:false,
      stock:9,
      images:[
        "https://picsum.photos/seed/pastel1/900/700",
        "https://picsum.photos/seed/pastel2/900/700",
      ],
    },
    {
      id:"tulip_21",
      title:"21 —Ç—é–ª—å–ø–∞–Ω",
      desc:"–ò–¥–µ–∞–ª—å–Ω–æ –Ω–∞ –≤–µ—Å–Ω—É –∏ —Å–≤–∏–¥–∞–Ω–∏–µ. –õ—ë–≥–∫–∏–π, —è—Ä–∫–∏–π –∏ —Å–≤–µ–∂–∏–π.",
      price:240000,
      premium:false,
      popular:72,
      fast:true,
      colors:["–ñ—ë–ª—Ç—ã–π","–†–æ–∑–æ–≤—ã–π","–ö—Ä–∞—Å–Ω—ã–π"],
      occasion:["8 –º–∞—Ä—Ç–∞","–†–æ–º–∞–Ω—Ç–∏–∫–∞"],
      recipient:["–õ—é–±–∏–º–∞—è","–ü–æ–¥—Ä—É–≥–∞"],
      tags:["–°–µ–∑–æ–Ω"],
      season:true,
      stock:0,
      images:[
        "https://picsum.photos/seed/tulip1/900/700",
        "https://picsum.photos/seed/tulip2/900/700",
        "https://picsum.photos/seed/tulip3/900/700",
      ],
    },
    {
      id:"premium_box",
      title:"–ü—Ä–µ–º–∏—É–º –≤ –∫–æ—Ä–æ–±–∫–µ",
      desc:"–ö–æ–º–ø–æ–∑–∏—Ü–∏—è –≤ —à–ª—è–ø–Ω–æ–π –∫–æ—Ä–æ–±–∫–µ. –°—Ç–∞–±–∏–ª—å–Ω–æ –¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ä–º—É, –≤—ã–≥–ª—è–¥–∏—Ç –¥–æ—Ä–æ–≥–æ.",
      price:490000,
      premium:true,
      popular:66,
      fast:false,
      colors:["–ë–µ–ª—ã–π","–†–æ–∑–æ–≤—ã–π"],
      occasion:["–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è","–†–æ–º–∞–Ω—Ç–∏–∫–∞","–°–≤–∞–¥—å–±–∞"],
      recipient:["–ñ–µ–Ω–∞","–õ—é–±–∏–º–∞—è","–ú–∞–º–∞"],
      tags:["Limited"],
      season:false,
      stock:4,
      images:[
        "https://picsum.photos/seed/box1/900/700",
        "https://picsum.photos/seed/box2/900/700",
      ],
    },
    {
      id:"wedding",
      title:"–°–≤–∞–¥–µ–±–Ω—ã–π –±—É–∫–µ—Ç",
      desc:"–ü–æ–¥–±–æ—Ä –ø–æ–¥ –ø–ª–∞—Ç—å–µ –∏ —Å—Ç–∏–ª—å. –ú–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤ –º–∞—Å—Ç–µ—Ä–µ-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ.",
      price:550000,
      premium:true,
      popular:41,
      fast:false,
      colors:["–ë–µ–ª—ã–π"],
      occasion:["–°–≤–∞–¥—å–±–∞"],
      recipient:["–ù–µ–≤–µ—Å—Ç–∞"],
      tags:["–ü—Ä–µ–º–∏—É–º"],
      season:false,
      stock:6,
      images:[
        "https://picsum.photos/seed/wed1/900/700",
        "https://picsum.photos/seed/wed2/900/700",
        "https://picsum.photos/seed/wed3/900/700",
      ],
    },
    {
      id:"corporate",
      title:"–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
      desc:"–î–ª—è —Ä–µ—Å–µ–ø—à–Ω / –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤. –ü—Ä–µ–º–∏—É–º –≤–∏–¥ + —Å–ø–æ–∫–æ–π–Ω—ã–π —Å—Ç–∏–ª—å.",
      price:420000,
      premium:true,
      popular:58,
      fast:false,
      colors:["–ë–µ–ª—ã–π","–ó–µ–ª—ë–Ω—ã–π"],
      occasion:["–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤"],
      recipient:["–ö–æ–ª–ª–µ–≥–∞","–ü–∞—Ä—Ç–Ω—ë—Ä"],
      tags:["–•–∏—Ç"],
      season:false,
      stock:7,
      images:[
        "https://picsum.photos/seed/corp1/900/700",
        "https://picsum.photos/seed/corp2/900/700",
      ],
    },
  ];

  const DELIVERY_ZONES = [
    { id:"center", name:"–¶–µ–Ω—Ç—Ä", fee:25000, eta:"60‚Äì90 –º–∏–Ω", urgent:true },
    { id:"near", name:"–ë–ª–∏–∂–Ω–∏–µ —Ä–∞–π–æ–Ω—ã", fee:35000, eta:"90‚Äì120 –º–∏–Ω", urgent:true },
    { id:"far", name:"–î–∞–ª—å–Ω–∏–µ —Ä–∞–π–æ–Ω—ã", fee:50000, eta:"120‚Äì180 –º–∏–Ω", urgent:false },
  ];

  const TIME_SLOTS = [
    "12:00‚Äì14:00",
    "14:00‚Äì16:00",
    "16:00‚Äì18:00",
    "18:00‚Äì20:00",
    "20:00‚Äì22:00",
  ];

  // ===== State =====
  const cart = new Map(); // id -> qty
  const mediaIndex = new Map(); // productId -> idx
  let deliveryType = "delivery"; // delivery/pickup
  let urgent = false;

  const filters = {
    priceMax: null,
    colors: new Set(),
    occasions: new Set(),
    recipients: new Set(),
    inStock: false,
    fast: false,
    sort: "popular",
    campaign: null,
  };

  // ===== DOM =====
  const grid = document.getElementById("grid");
  const stories = document.getElementById("stories");

  const drawer = document.getElementById("drawer");
  const cartList = document.getElementById("cartList");
  const cartCount = document.getElementById("cartCount");
  const totalText = document.getElementById("totalText");
  const drawerSubtotal = document.getElementById("drawerSubtotal");
  const drawerDeliveryFee = document.getElementById("drawerDeliveryFee");
  const drawerTotal = document.getElementById("drawerTotal");

  const filtersDrawer = document.getElementById("filters");
  const profileDrawer = document.getElementById("profile");

  const overlay = document.getElementById("overlay");
  const productModal = document.getElementById("productModal");
  const pmImg = document.getElementById("pmImg");
  const pmTitle = document.getElementById("pmTitle");
  const pmH = document.getElementById("pmH");
  const pmDesc = document.getElementById("pmDesc");
  const pmPrice = document.getElementById("pmPrice");
  const pmStock = document.getElementById("pmStock");
  const pmAdd = document.getElementById("pmAdd");
  const pmRecs = document.getElementById("pmRecs");

  const wOverlay = document.getElementById("wOverlay");
  const wizardModal = document.getElementById("wizardModal");
  const stepsEl = document.getElementById("steps");
  const wizBody = document.getElementById("wizBody");

  // ===== LocalStorage =====
  function loadProfile(){
    try{
      return JSON.parse(localStorage.getItem(LS.profile) || "null") || {};
    }catch(e){ return {}; }
  }
  function saveProfileObj(p){
    localStorage.setItem(LS.profile, JSON.stringify(p));
  }
  function loadFavs(){
    try{
      return new Set(JSON.parse(localStorage.getItem(LS.favs) || "[]"));
    }catch(e){ return new Set(); }
  }
  function saveFavs(set){
    localStorage.setItem(LS.favs, JSON.stringify([...set]));
  }
  function loadReminders(){
    try{
      return JSON.parse(localStorage.getItem(LS.reminders) || "[]") || [];
    }catch(e){ return []; }
  }
  function saveReminders(arr){
    localStorage.setItem(LS.reminders, JSON.stringify(arr));
  }

  const favs = loadFavs();

  // ===== Computations =====
  function getSubtotal(){
    let total = 0;
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x=>x.id===id);
      if (p) total += p.price * qty;
    }
    return total;
  }
  function selectedZone(){
    const z = document.getElementById("zone").value;
    return DELIVERY_ZONES.find(x=>x.id===z) || DELIVERY_ZONES[0];
  }
  function getDeliveryFee(){
    if (deliveryType === "pickup") return 0;
    return selectedZone().fee;
  }
  function getTotal(){
    return getSubtotal() + getDeliveryFee();
  }

  function cartItems(){
    const items = [];
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x=>x.id===id);
      if (p) items.push({p, qty});
    }
    return items;
  }

  // ===== Similar products =====
  function similarTo(p){
    const pool = PRODUCTS.filter(x=>x.id!==p.id);
    const score = (a)=>{
      let s=0;
      a.colors?.forEach(c=>{ if (p.colors.includes(c)) s+=2; });
      a.occasion?.forEach(o=>{ if (p.occasion.includes(o)) s+=2; });
      a.recipient?.forEach(r=>{ if (p.recipient.includes(r)) s+=1; });
      if (a.premium === p.premium) s+=1;
      if (a.fast && p.fast) s+=1;
      const diff = Math.abs(a.price - p.price);
      s += Math.max(0, 3 - diff/150000);
      return s;
    };
    return pool.sort((x,y)=>score(y)-score(x)).slice(0,6);
  }

  // ===== Stories =====
  function renderStories(){
    stories.innerHTML = "";
    BANNERS.forEach(b=>{
      const el = document.createElement("div");
      el.className = "story";
      el.innerHTML = `
        <div class="tag">${b.tag}</div>
        <h3>‚ú® ${b.title}</h3>
        <p>${b.desc}</p>
        <div class="cta">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–±–æ—Ä ‚Üí</div>
      `;
      el.addEventListener("click", ()=>{
        filters.campaign = b.filter || null;
        toast(b.title);
        renderGrid();
      });
      stories.appendChild(el);
    });
  }

  // ===== Filters UI chips =====
  function uniqueValues(key){
    const set = new Set();
    PRODUCTS.forEach(p=>{
      (p[key]||[]).forEach(v=>set.add(v));
    });
    return [...set].sort();
  }

  function renderChips(containerId, values, selectedSet){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    values.forEach(v=>{
      const b = document.createElement("button");
      b.className = "tbtn";
      b.textContent = v;
      if (selectedSet.has(v)) b.classList.add("on");
      b.addEventListener("click", ()=>{
        if (selectedSet.has(v)) selectedSet.delete(v);
        else selectedSet.add(v);
        renderChips(containerId, values, selectedSet);
        haptic();
      });
      el.appendChild(b);
    });
  }

  // ===== Apply filters/sort =====
  function applyAll(products){
    let list = [...products];

    // campaign filter
    if (filters.campaign){
      const f = filters.campaign;
      if (f.occasion) list = list.filter(p=>p.occasion.includes(f.occasion));
      if (f.season === true) list = list.filter(p=>p.season === true);
    }

    if (filters.priceMax && Number(filters.priceMax) > 0){
      list = list.filter(p=>p.price <= Number(filters.priceMax));
    }
    if (filters.colors.size){
      list = list.filter(p=>p.colors.some(c=>filters.colors.has(c)));
    }
    if (filters.occasions.size){
      list = list.filter(p=>p.occasion.some(o=>filters.occasions.has(o)));
    }
    if (filters.recipients.size){
      list = list.filter(p=>p.recipient.some(r=>filters.recipients.has(r)));
    }
    if (filters.inStock){
      list = list.filter(p=>p.stock > 0);
    }
    if (filters.fast){
      list = list.filter(p=>p.fast);
    }

    // sort
    const s = filters.sort;
    if (s === "popular") list.sort((a,b)=> (b.popular||0) - (a.popular||0));
    if (s === "fast") list.sort((a,b)=> (b.fast?1:0) - (a.fast?1:0) || (b.popular||0)-(a.popular||0));
    if (s === "premium") list.sort((a,b)=> (b.premium?1:0) - (a.premium?1:0) || (b.popular||0)-(a.popular||0));
    if (s === "under300") list.sort((a,b)=> (a.price - b.price));
    if (s === "priceAsc") list.sort((a,b)=> a.price - b.price);
    if (s === "priceDesc") list.sort((a,b)=> b.price - a.price);

    return list;
  }

  // ===== Cards render =====
  function badgeClass(t){
    const s = (t||"").toLowerCase();
    if (s.includes("—Ö–∏—Ç")) return "b-hit";
    if (s.includes("–Ω–æ–≤")) return "b-new";
    if (s.includes("limit")) return "b-limited";
    if (s.includes("—Å–µ–∑")) return "b-season";
    if (s.includes("–ø—Ä–µ–º")) return "b-new";
    return "b-new";
  }

  function renderGrid(){
    const list = applyAll(PRODUCTS);

    grid.innerHTML = "";
    list.forEach(p=>{
      if (!mediaIndex.has(p.id)) mediaIndex.set(p.id, 0);

      const el = document.createElement("div");
      el.className = "card";
      const idx = mediaIndex.get(p.id) || 0;

      const tags = [];
      (p.tags||[]).forEach(t=>tags.push(t));
      if (p.season && !tags.includes("–°–µ–∑–æ–Ω")) tags.push("–°–µ–∑–æ–Ω");
      if (p.premium && !tags.includes("–ü—Ä–µ–º–∏—É–º")) tags.push("–ü—Ä–µ–º–∏—É–º");
      if (p.stock <= 0 && !tags.includes("–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç")) tags.push("–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç");

      const chips = [
        p.fast ? "‚ö° –ë—ã—Å—Ç—Ä–æ" : null,
        p.premium ? "üíé Premium" : null,
      ].filter(Boolean).map(x=>`<span class="chip">${x}</span>`).join("");

      const favOn = favs.has(p.id);

      el.innerHTML = `
        <div class="badges">
          ${(p.tags||[]).slice(0,2).map(t=>`<span class="badge ${badgeClass(t)}">${t}</span>`).join("")}
          ${p.season ? `<span class="badge b-season">–°–µ–∑–æ–Ω</span>` : ``}
          ${p.stock<=0 ? `<span class="badge b-limited">–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç</span>` : ``}
        </div>

        <div class="fav ${favOn?'on':''}" data-fav="${p.id}" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 21s-7-4.6-9.5-8.6C.6 9 .9 6.3 2.7 4.6 4.6 2.7 7.5 2.9 9.2 4.7L12 7.6l2.8-2.9c1.7-1.8 4.6-2 6.5-.1 1.8 1.7 2.1 4.4.2 7.8C19 16.4 12 21 12 21Z"/></svg>
        </div>

        <div class="media" data-open="${p.id}">
          <div class="track" id="track_${p.id}" style="transform:translateX(-${idx*100}%)">
            ${(p.images||[]).slice(0,4).map(src=>`
              <div class="slide"><img src="${src}" alt=""></div>
            `).join("")}
          </div>
          <div class="dots" id="dots_${p.id}">
            ${(p.images||[]).slice(0,4).map((_,i)=>`<div class="dot ${i===idx?'on':''}"></div>`).join("")}
          </div>
          ${p.stock<=0 ? `<div class="out">–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç</div>` : ``}
        </div>

        <div class="cbody">
          <div class="title">${p.title}</div>
          <div class="meta">${chips}</div>
          <div class="desc">${p.desc}</div>
          <div class="row">
            <div class="price">${money(p.price)} ${CURRENCY}</div>
            <button class="btn" data-add="${p.id}" ${p.stock<=0?'disabled':''}>${p.stock<=0?'–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏':'‚ûï –í –∫–æ—Ä–∑–∏–Ω—É'}</button>
          </div>
          ${p.stock<=0 ? `<button class="btn secondary" data-replace="${p.id}">üîÅ –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–º–µ–Ω—É</button>` : ``}
        </div>
      `;
      grid.appendChild(el);

      // swipe carousel on card
      const media = el.querySelector(`[data-open="${p.id}"]`);
      const track = el.querySelector(`#track_${p.id}`);
      const dots = el.querySelector(`#dots_${p.id}`);

      let startX=0, curX=0, dragging=false;

      media.addEventListener("touchstart", (e)=>{
        dragging=true;
        startX = e.touches[0].clientX;
        curX = startX;
      }, {passive:true});

      media.addEventListener("touchmove", (e)=>{
        if (!dragging) return;
        curX = e.touches[0].clientX;
      }, {passive:true});

      media.addEventListener("touchend", ()=>{
        if (!dragging) return;
        dragging=false;
        const dx = curX - startX;
        const max = Math.min(3, (p.images||[]).length-1);
        let i = mediaIndex.get(p.id) || 0;
        if (dx < -30) i = Math.min(max, i+1);
        if (dx > 30) i = Math.max(0, i-1);
        mediaIndex.set(p.id, i);
        track.style.transform = `translateX(-${i*100}%)`;
        [...dots.children].forEach((d,di)=>d.classList.toggle("on", di===i));
      });

      // tap opens product modal (zoom etc.)
      media.addEventListener("click", ()=> openProduct(p.id));

      // add
      el.querySelectorAll(`[data-add="${p.id}"]`).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          cart.set(p.id, (cart.get(p.id)||0) + 1);
          syncUI();
          haptic();
          toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
        });
      });

      // replacement
      el.querySelectorAll(`[data-replace="${p.id}"]`).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const sim = similarTo(p).filter(x=>x.stock>0);
          if (!sim.length){
            toast("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–º–µ–Ω —Å–µ–π—á–∞—Å");
            return;
          }
          openProduct(sim[0].id);
        });
      });

      // fav
      el.querySelectorAll(`[data-fav="${p.id}"]`).forEach(f=>{
        f.addEventListener("click", (e)=>{
          e.stopPropagation();
          if (favs.has(p.id)) favs.delete(p.id);
          else favs.add(p.id);
          saveFavs(favs);
          renderGrid();
          renderFavList();
          haptic();
        });
      });
    });

    syncUI();
  }

  // ===== Product modal (zoom + similar) =====
  let currentProduct = null;
  let zoom = 1;

  function openProduct(id){
    const p = PRODUCTS.find(x=>x.id===id);
    if (!p) return;
    currentProduct = p;
    zoom = 1;
    pmTitle.textContent = p.title;
    pmH.textContent = p.title;
    pmDesc.textContent = p.desc;
    pmPrice.textContent = `${money(p.price)} ${CURRENCY}`;
    pmStock.textContent = p.stock>0 ? `–í –Ω–∞–ª–∏—á–∏–∏: ${p.stock}` : `–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º –∑–∞–º–µ–Ω—É`;
    pmAdd.disabled = p.stock<=0;
    pmAdd.textContent = p.stock>0 ? "‚ûï –í –∫–æ—Ä–∑–∏–Ω—É" : "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏";
    pmImg.src = (p.images||[])[0] || "";
    pmImg.style.transform = `scale(${zoom})`;
    renderSimilar(p);
    overlay.classList.add("open");
    productModal.classList.add("open");
  }
  function closeProduct(){
    overlay.classList.remove("open");
    productModal.classList.remove("open");
  }
  function renderSimilar(p){
    const sim = similarTo(p);
    pmRecs.innerHTML = "";
    sim.forEach(s=>{
      const el = document.createElement("div");
      el.className = "rec";
      el.innerHTML = `
        <div class="im"><img src="${(s.images||[])[0]||""}" alt=""></div>
        <div class="b">
          <b>${s.title}</b>
          <span>${money(s.price)} ${CURRENCY}${s.stock<=0 ? " ‚Ä¢ –Ω–µ—Ç" : ""}</span>
        </div>
      `;
      el.addEventListener("click", ()=> openProduct(s.id));
      pmRecs.appendChild(el);
    });
  }

  document.getElementById("closeProduct").addEventListener("click", closeProduct);
  overlay.addEventListener("click", closeProduct);

  document.getElementById("pmAdd").addEventListener("click", ()=>{
    if (!currentProduct || currentProduct.stock<=0) return;
    cart.set(currentProduct.id, (cart.get(currentProduct.id)||0)+1);
    syncUI();
    haptic();
    toast("–î–æ–±–∞–≤–ª–µ–Ω–æ");
  });

  document.getElementById("pmShowSimilar").addEventListener("click", ()=>{
    if (!currentProduct) return;
    toast("–ü–æ—Ö–æ–∂–∏–µ –ø–æ–∫–∞–∑–∞–Ω—ã –Ω–∏–∂–µ");
    document.getElementById("pmRecs").scrollIntoView({behavior:"smooth", block:"start"});
  });

  document.getElementById("zPlus").addEventListener("click", ()=>{
    zoom = Math.min(2.4, zoom + 0.2);
    pmImg.style.transform = `scale(${zoom})`;
  });
  document.getElementById("zMinus").addEventListener("click", ()=>{
    zoom = Math.max(1, zoom - 0.2);
    pmImg.style.transform = `scale(${zoom})`;
  });

  // ===== Cart render =====
  function renderCart(){
    const items = cartItems();
    if (items.length === 0){
      cartList.innerHTML = `<div class="muted">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –±—É–∫–µ—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ üå∏</div>`;
      return;
    }

    cartList.innerHTML = "";
    items.forEach(({p, qty})=>{
      const row = document.createElement("div");
      row.className = "cartitem";
      row.innerHTML = `
        <div>
          <div style="font-weight:950">${p.title}</div>
          <div class="muted">${money(p.price)} ${CURRENCY} –∑–∞ 1 ‚Ä¢ ${p.fast ? "‚ö° –±—ã—Å—Ç—Ä–æ" : "–æ–±—ã—á–Ω–∞—è"}</div>
        </div>
        <div class="qty">
          <button class="qbtn" data-act="minus" data-id="${p.id}">‚àí</button>
          <b>${qty}</b>
          <button class="qbtn" data-act="plus" data-id="${p.id}">+</button>
        </div>
      `;
      cartList.appendChild(row);
    });

    cartList.querySelectorAll("button[data-act]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.dataset.id;
        const act = b.dataset.act;
        const cur = cart.get(id) || 0;
        if (act === "plus") cart.set(id, cur + 1);
        if (act === "minus"){
          const next = cur - 1;
          if (next <= 0) cart.delete(id);
          else cart.set(id, next);
        }
        syncUI();
        renderCart();
        haptic();
      });
    });
  }

  function syncUI(){
    const count = [...cart.values()].reduce((a,b)=>a+b,0);
    cartCount.textContent = count;

    const subtotal = getSubtotal();
    const fee = getDeliveryFee();
    const total = getTotal();

    totalText.textContent = `–ò—Ç–æ–≥–æ: ${money(total)} ${CURRENCY}`;
    drawerSubtotal.textContent = `${money(subtotal)} ${CURRENCY}`;
    drawerDeliveryFee.textContent = `${money(fee)} ${CURRENCY}`;
    drawerTotal.textContent = `${money(total)} ${CURRENCY}`;

    // hint
    const z = selectedZone();
    const hint = (deliveryType==="pickup")
      ? "–°–∞–º–æ–≤—ã–≤–æ–∑ ‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ"
      : `–ó–æ–Ω–∞: ${z.name} ‚Ä¢ ${z.eta} ‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ ${money(z.fee)} ${CURRENCY}`;
    document.getElementById("hintText").textContent = hint;
  }

  function openDrawer(){
    drawer.classList.add("open");
    renderCart();
    syncUI();
  }
  function closeDrawer(){
    drawer.classList.remove("open");
  }

  document.getElementById("openCart").addEventListener("click", openDrawer);
  document.getElementById("openCart2").addEventListener("click", openDrawer);
  document.getElementById("closeDrawer").addEventListener("click", closeDrawer);

  document.getElementById("clearCart").addEventListener("click", ()=>{
    cart.clear();
    syncUI();
    renderCart();
    toast("–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞");
  });

  // ===== Delivery type / urgent =====
  const tDelivery = document.getElementById("tDelivery");
  const tPickup = document.getElementById("tPickup");
  const addressField = document.getElementById("addressField");
  const zoneField = document.getElementById("zoneField");

  function setDeliveryType(type){
    deliveryType = type;
    tDelivery.classList.toggle("on", type==="delivery");
    tPickup.classList.toggle("on", type==="pickup");
    addressField.style.display = (type==="delivery") ? "flex" : "none";
    zoneField.style.display = (type==="delivery") ? "flex" : "none";
    urgent = false;
    document.getElementById("urgentBtn").classList.remove("on");
    syncUI();
  }
  tDelivery.addEventListener("click", ()=>{ setDeliveryType("delivery"); haptic(); });
  tPickup.addEventListener("click", ()=>{ setDeliveryType("pickup"); haptic(); });

  document.getElementById("urgentBtn").addEventListener("click", ()=>{
    if (deliveryType !== "delivery"){
      toast("–°—Ä–æ—á–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏");
      return;
    }
    const z = selectedZone();
    if (!z.urgent){
      toast("–í —ç—Ç–æ–π –∑–æ–Ω–µ —Å—Ä–æ—á–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");
      urgent = false;
      document.getElementById("urgentBtn").classList.remove("on");
      return;
    }
    urgent = !urgent;
    document.getElementById("urgentBtn").classList.toggle("on", urgent);
    toast(urgent ? "–°—Ä–æ—á–Ω–æ –≤–∫–ª—é—á–µ–Ω–æ" : "–°—Ä–æ—á–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–æ");
    haptic();
  });

  // zones & slots
  function initZones(){
    const sel = document.getElementById("zone");
    sel.innerHTML = "";
    DELIVERY_ZONES.forEach(z=>{
      const opt = document.createElement("option");
      opt.value = z.id;
      opt.textContent = `${z.name} ‚Ä¢ ${money(z.fee)} ${CURRENCY} ‚Ä¢ ${z.eta}`;
      sel.appendChild(opt);
    });
    sel.addEventListener("change", ()=>{
      // urgent availability depends on zone
      if (urgent && !selectedZone().urgent){
        urgent = false;
        document.getElementById("urgentBtn").classList.remove("on");
      }
      syncUI();
    });
  }
  function initSlots(){
    const sel = document.getElementById("slot");
    sel.innerHTML = "";
    TIME_SLOTS.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    });
  }

  // ===== Filters drawer =====
  function openFilters(){
    filtersDrawer.classList.add("open");
  }
  function closeFilters(){
    filtersDrawer.classList.remove("open");
  }
  document.getElementById("openFilters").addEventListener("click", openFilters);
  document.getElementById("closeFilters").addEventListener("click", closeFilters);

  const fInStock = document.getElementById("fInStock");
  const fFast = document.getElementById("fFast");

  fInStock.addEventListener("click", ()=>{
    filters.inStock = !filters.inStock;
    fInStock.classList.toggle("on", filters.inStock);
    haptic();
  });
  fFast.addEventListener("click", ()=>{
    filters.fast = !filters.fast;
    fFast.classList.toggle("on", filters.fast);
    haptic();
  });

  document.getElementById("resetFilters").addEventListener("click", ()=>{
    filters.priceMax = null;
    filters.colors.clear();
    filters.occasions.clear();
    filters.recipients.clear();
    filters.inStock = false;
    filters.fast = false;
    filters.sort = "popular";
    filters.campaign = null;

    document.getElementById("priceMax").value = "";
    document.getElementById("sort").value = "popular";
    fInStock.classList.remove("on");
    fFast.classList.remove("on");

    renderChips("colorChips", uniqueValues("colors"), filters.colors);
    renderChips("occasionChips", uniqueValues("occasion"), filters.occasions);
    renderChips("recipientChips", uniqueValues("recipient"), filters.recipients);
    toast("–°–±—Ä–æ—à–µ–Ω–æ");
  });

  document.getElementById("applyFilters").addEventListener("click", ()=>{
    filters.priceMax = document.getElementById("priceMax").value.trim() || null;
    filters.sort = document.getElementById("sort").value;
    renderGrid();
    closeFilters();
    toast("–ü—Ä–∏–º–µ–Ω–µ–Ω–æ");
  });

  // ===== Profile drawer =====
  function openProfile(){
    profileDrawer.classList.add("open");
    renderProfileUI();
  }
  function closeProfile(){
    profileDrawer.classList.remove("open");
  }
  document.getElementById("openProfile").addEventListener("click", openProfile);
  document.getElementById("closeProfile").addEventListener("click", closeProfile);

  function renderProfileUI(){
    const p = loadProfile();
    document.getElementById("pName").value = p.name || "";
    document.getElementById("pPhone").value = p.phone || "";
    document.getElementById("pAddresses").value = (p.addresses||[]).join("; ");
    document.getElementById("pRecipients").value = (p.recipients||[]).join("; ");

    // also fill checkout
    document.getElementById("name").value = document.getElementById("name").value || (p.name||"");
    document.getElementById("phone").value = document.getElementById("phone").value || (p.phone||"");
    if (!document.getElementById("address").value && (p.addresses||[])[0]) {
      document.getElementById("address").value = p.addresses[0];
    }
    if (!document.getElementById("recipient").value && (p.recipients||[])[0]) {
      document.getElementById("recipient").value = p.recipients[0];
    }

    renderReminders();
    renderFavList();
  }

  document.getElementById("saveProfile").addEventListener("click", ()=>{
    const obj = {
      name: document.getElementById("pName").value.trim(),
      phone: document.getElementById("pPhone").value.trim(),
      addresses: document.getElementById("pAddresses").value.split(";").map(s=>s.trim()).filter(Boolean),
      recipients: document.getElementById("pRecipients").value.split(";").map(s=>s.trim()).filter(Boolean),
    };
    saveProfileObj(obj);
    toast("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    haptic();
    renderProfileUI();
  });

  function renderFavList(){
    const box = document.getElementById("favList");
    const ids = [...favs];
    if (!ids.length){
      box.innerHTML = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏—Ç–µ ‚ù§Ô∏è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –±—É–∫–µ—Ç–∞.";
      return;
    }
    const list = ids.map(id=>PRODUCTS.find(p=>p.id===id)).filter(Boolean);
    box.innerHTML = list.map(p=>`‚Ä¢ <b>${p.title}</b> ‚Äî ${money(p.price)} ${CURRENCY}`).join("<br>");
  }

  document.getElementById("addReminder").addEventListener("click", ()=>{
    const who = document.getElementById("rWho").value.trim();
    const date = document.getElementById("rDate").value.trim();
    if (!who || !date){
      toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º—É –∏ –¥–∞—Ç—É");
      return;
    }
    const arr = loadReminders();
    arr.push({ id: uid(), who, date });
    saveReminders(arr);
    document.getElementById("rWho").value = "";
    document.getElementById("rDate").value = "";
    renderReminders();
    toast("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
  });

  function renderReminders(){
    const arr = loadReminders();
    const el = document.getElementById("remindersList");
    if (!arr.length){
      el.innerHTML = "–ù–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ: ¬´–î–† –º–∞–º—ã —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π¬ª –∏ —Ç.–¥.";
      return;
    }
    el.innerHTML = arr.map(r=>`
      <div style="padding:10px;border:1px solid rgba(0,0,0,.08);border-radius:14px;margin:8px 0;background:#fff">
        <b>${r.who}</b> ‚Äî <span class="muted">${r.date}</span>
        <button class="btn ghost" data-delrem="${r.id}" style="float:right;padding:8px 10px;border-radius:12px">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `).join("");
    el.querySelectorAll("[data-delrem]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.dataset.delrem;
        const next = arr.filter(x=>x.id!==id);
        saveReminders(next);
        renderReminders();
        toast("–£–¥–∞–ª–µ–Ω–æ");
      });
    });
  }

  // ===== Wizard (premium bouquet builder) =====
  const WIZ = {
    step: 0,
    data: {
      occasion: null,
      colors: [],
      mood: null,
      budget: null,
      wrap: null,
      card: null,
      delivery: null,
      addons: [],
    }
  };

  const WIZ_STEPS = [
    { key:"occasion", title:"–ü–æ–≤–æ–¥" },
    { key:"colors", title:"–¶–≤–µ—Ç–∞" },
    { key:"mood", title:"–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ" },
    { key:"budget", title:"–ë—é–¥–∂–µ—Ç" },
    { key:"wrap", title:"–£–ø–∞–∫–æ–≤–∫–∞" },
    { key:"card", title:"–û—Ç–∫—Ä—ã—Ç–∫–∞" },
    { key:"delivery", title:"–î–æ—Å—Ç–∞–≤–∫–∞" },
  ];

  function openWizard(){
    wOverlay.classList.add("open");
    wizardModal.classList.add("open");
    WIZ.step = 0;
    WIZ.data = { occasion:null, colors:[], mood:null, budget:null, wrap:null, card:null, delivery:null, addons:[] };
    renderWizard();
  }
  function closeWizard(){
    wOverlay.classList.remove("open");
    wizardModal.classList.remove("open");
  }
  document.getElementById("openWizard").addEventListener("click", openWizard);
  document.getElementById("closeWizard").addEventListener("click", closeWizard);
  wOverlay.addEventListener("click", closeWizard);

  function renderWizard(){
    stepsEl.innerHTML = "";
    WIZ_STEPS.forEach((s,i)=>{
      const d = document.createElement("div");
      d.className = "stepDot " + (i<=WIZ.step ? "on" : "");
      stepsEl.appendChild(d);
    });

    const stepKey = WIZ_STEPS[WIZ.step].key;

    const btnNext = `<button class="btn" id="wizNext">–î–∞–ª–µ–µ ‚Üí</button>`;
    const btnBack = `<button class="btn secondary" id="wizBack">‚Üê –ù–∞–∑–∞–¥</button>`;
    const footer = `
      <div class="hr"></div>
      <div class="two">
        ${WIZ.step>0 ? btnBack : `<div></div>`}
        ${WIZ.step < WIZ_STEPS.length-1 ? btnNext : `<button class="btn" id="wizDone">‚úÖ –ü–æ–¥–æ–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã</button>`}
      </div>
    `;

    if (stepKey === "occasion"){
      wizBody.innerHTML = `
        <div class="sectionTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–≤–æ–¥</div>
        <div class="toggle" id="wizOcc"></div>
        ${footer}
      `;
      const values = uniqueValues("occasion");
      const box = document.getElementById("wizOcc");
      values.forEach(v=>{
        const b = document.createElement("button");
        b.className = "tbtn" + (WIZ.data.occasion===v ? " on":"");
        b.textContent = v;
        b.addEventListener("click", ()=>{
          WIZ.data.occasion = v;
          renderWizard();
          haptic();
        });
        box.appendChild(b);
      });
    }

    if (stepKey === "colors"){
      wizBody.innerHTML = `
        <div class="sectionTitle">–¶–≤–µ—Ç–∞ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</div>
        <div class="toggle" id="wizColors"></div>
        ${footer}
      `;
      const values = uniqueValues("colors");
      const box = document.getElementById("wizColors");
      values.forEach(v=>{
        const on = WIZ.data.colors.includes(v);
        const b = document.createElement("button");
        b.className = "tbtn" + (on ? " on":"");
        b.textContent = v;
        b.addEventListener("click", ()=>{
          if (WIZ.data.colors.includes(v)) WIZ.data.colors = WIZ.data.colors.filter(x=>x!==v);
          else WIZ.data.colors.push(v);
          renderWizard();
          haptic();
        });
        box.appendChild(b);
      });
    }

    if (stepKey === "mood"){
      const moods = ["–ù–µ–∂–Ω–æ", "–Ø—Ä–∫–æ", "–†–æ–º–∞–Ω—Ç–∏–∫–∞", "–ú–∏–Ω–∏–º–∞–ª–∏–∑–º", "–ü—Ä–µ–º–∏—É–º"];
      wizBody.innerHTML = `
        <div class="sectionTitle">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
        <div class="toggle" id="wizMood"></div>
        ${footer}
      `;
      const box = document.getElementById("wizMood");
      moods.forEach(v=>{
        const b = document.createElement("button");
        b.className = "tbtn" + (WIZ.data.mood===v ? " on":"");
        b.textContent = v;
        b.addEventListener("click", ()=>{
          WIZ.data.mood = v;
          renderWizard();
          haptic();
        });
        box.appendChild(b);
      });
    }

    if (stepKey === "budget"){
      const budgets = [
        {k:"–¥–æ 300k", max:300000},
        {k:"300‚Äì500k", max:500000},
        {k:"500k+", max:99999999},
      ];
      wizBody.innerHTML = `
        <div class="sectionTitle">–ë—é–¥–∂–µ—Ç</div>
        <div class="toggle" id="wizBud"></div>
        <div class="hr"></div>
        <div class="sectionTitle">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–ø–∞—Ä—Ç–Ω—ë—Ä–∫–∞)</div>
        <div class="toggle" id="wizAdd"></div>
        ${footer}
      `;
      const box = document.getElementById("wizBud");
      budgets.forEach(v=>{
        const b = document.createElement("button");
        b.className = "tbtn" + (WIZ.data.budget?.k===v.k ? " on":"");
        b.textContent = v.k;
        b.addEventListener("click", ()=>{
          WIZ.data.budget = v;
          renderWizard();
          haptic();
        });
        box.appendChild(b);
      });

      const add = ["üéà –®–∞—Ä–∏–∫–∏","üç´ –ö–æ–Ω—Ñ–µ—Ç—ã","üß∏ –ò–≥—Ä—É—à–∫–∞","üå∏ –ü–∞—Ä—Ñ—é–º (–ø–∞—Ä—Ç–Ω—ë—Ä–∫–∞)"];
      const aBox = document.getElementById("wizAdd");
      add.forEach(v=>{
        const on = WIZ.data.addons.includes(v);
        const b = document.createElement("button");
        b.className = "tbtn" + (on ? " on":"");
        b.textContent = v;
        b.addEventListener("click", ()=>{
          if (on) WIZ.data.addons = WIZ.data.addons.filter(x=>x!==v);
          else WIZ.data.addons.push(v);
          renderWizard();
          haptic();
        });
        aBox.appendChild(b);
      });
    }

    if (stepKey === "wrap"){
      const wraps = ["–ö–ª–∞—Å—Å–∏–∫–∞","–ü—Ä–µ–º–∏—É–º (–ª—ë–Ω/—Å–∞—Ç–∏–Ω)","–ú–∏–Ω–∏–º–∞–ª–∏–∑–º (–∫—Ä–∞—Ñ—Ç)","–Ø—Ä–∫–∞—è (–∞–∫—Ü–µ–Ω—Ç)"];
      wizBody.innerHTML = `
        <div class="sectionTitle">–£–ø–∞–∫–æ–≤–∫–∞</div>
        <div class="toggle" id="wizWrap"></div>
        ${footer}
      `;
      const box = document.getElementById("wizWrap");
      wraps.forEach(v=>{
        const b = document.createElement("button");
        b.className = "tbtn" + (WIZ.data.wrap===v ? " on":"");
        b.textContent = v;
        b.addEventListener("click", ()=>{
          WIZ.data.wrap = v;
          renderWizard();
          haptic();
        });
        box.appendChild(b);
      });
    }

    if (stepKey === "card"){
      wizBody.innerHTML = `
        <div class="sectionTitle">–¢–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏</div>
        <div class="field">
          <label>–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º</label>
          <textarea id="wizCard" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –° –ª—é–±–æ–≤—å—é ‚ù§Ô∏è"></textarea>
        </div>
        ${footer}
      `;
      setTimeout(()=>{
        const t = document.getElementById("wizCard");
        t.value = WIZ.data.card || "";
        t.addEventListener("input", ()=>{ WIZ.data.card = t.value; });
      }, 0);
    }

    if (stepKey === "delivery"){
      wizBody.innerHTML = `
        <div class="sectionTitle">–î–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="toggle" id="wizDel"></div>
        <div class="muted" style="margin-top:10px">
          –ú—ã –ø–µ—Ä–µ–Ω–µ—Å—ë–º –≤—ã–±–æ—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É (—Å–ª–æ—Ç—ã, –∑–æ–Ω—ã –∏ —Ç.–¥.).
        </div>
        ${footer}
      `;
      const opts = ["–î–æ—Å—Ç–∞–≤–∫–∞", "–°–∞–º–æ–≤—ã–≤–æ–∑"];
      const box = document.getElementById("wizDel");
      opts.forEach(v=>{
        const b = document.createElement("button");
        b.className = "tbtn" + (WIZ.data.delivery===v ? " on":"");
        b.textContent = v;
        b.addEventListener("click", ()=>{
          WIZ.data.delivery = v;
          renderWizard();
          haptic();
        });
        box.appendChild(b);
      });
    }

    // nav buttons
    const back = document.getElementById("wizBack");
    if (back){
      back.addEventListener("click", ()=>{
        WIZ.step = Math.max(0, WIZ.step-1);
        renderWizard();
      });
    }
    const next = document.getElementById("wizNext");
    if (next){
      next.addEventListener("click", ()=>{
        WIZ.step = Math.min(WIZ_STEPS.length-1, WIZ.step+1);
        renderWizard();
      });
    }

    const done = document.getElementById("wizDone");
    if (done){
      done.addEventListener("click", ()=>{
        // auto recommendations: pick 3 best matching
        let list = PRODUCTS.filter(p=>p.stock>0);
        if (WIZ.data.occasion) list = list.filter(p=>p.occasion.includes(WIZ.data.occasion));
        if (WIZ.data.colors?.length) list = list.filter(p=>p.colors.some(c=>WIZ.data.colors.includes(c)));
        if (WIZ.data.budget) list = list.filter(p=>p.price <= WIZ.data.budget.max);
        // mood mapping
        if (WIZ.data.mood === "–ü—Ä–µ–º–∏—É–º") list = list.filter(p=>p.premium);
        if (WIZ.data.mood === "–Ø—Ä–∫–æ") list = list.filter(p=>p.colors.includes("–ö—Ä–∞—Å–Ω—ã–π") || p.colors.includes("–ñ—ë–ª—Ç—ã–π") || p.colors.includes("–†–æ–∑–æ–≤—ã–π"));
        list.sort((a,b)=>(b.popular||0)-(a.popular||0));
        const pick = list.slice(0,3);

        // apply selected options to checkout
        if (WIZ.data.wrap) document.getElementById("wrap").value = WIZ.data.wrap;
        if (WIZ.data.card) document.getElementById("cardText").value = WIZ.data.card;
        if (WIZ.data.delivery === "–°–∞–º–æ–≤—ã–≤–æ–∑") setDeliveryType("pickup"); else setDeliveryType("delivery");
        // addons -> comment
        if (WIZ.data.addons?.length){
          const c = document.getElementById("comment");
          const addText = "–î–æ–ø—ã: " + WIZ.data.addons.join(", ");
          c.value = (c.value ? c.value + "\n" : "") + addText;
        }

        closeWizard();
        openDrawer();

        if (!pick.length){
          toast("–ù–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥");
          return;
        }

        toast("–ü–æ–¥–æ–±—Ä–∞–ª–∏ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞");
        pick.forEach(p=>{
          cart.set(p.id, (cart.get(p.id)||0)+1);
        });
        syncUI();
        renderCart();
      });
    }
  }

  // ===== Order payload =====
  function makeOrderPayload(){
    const items = [];
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x=>x.id===id);
      if (!p) continue;
      items.push({ id:p.id, title:p.title, qty, price:p.price });
    }

    const now = new Date();
    return {
      type: "order",
      createdAt: now.toISOString(),
      status: "accepted",
      deliveryType: deliveryType,
      urgent: urgent,
      zone: deliveryType==="delivery" ? selectedZone().name : "",
      deliveryFee: getDeliveryFee(),
      deliverySlot: document.getElementById("slot").value,
      customer: {
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        date: document.getElementById("date").value.trim(),
        time: "", // (–æ—Å—Ç–∞–≤–∏–ª–∏ –ø–æ–¥ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å; —Å–ª–æ—Ç –≤—ã—à–µ)
        comment: document.getElementById("comment").value.trim(),
        recipient: document.getElementById("recipient").value.trim(),
        wrap: document.getElementById("wrap").value,
        cardText: document.getElementById("cardText").value.trim(),
        paymentMethod: document.getElementById("payment").value,
      },
      items,
      subtotal: getSubtotal(),
      total: getTotal(),
      currency: CURRENCY
    };
  }

  function validate(payload){
    if (!payload.items.length) return "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.";
    if (!payload.customer.name) return "–í–≤–µ–¥–∏—Ç–µ –∏–º—è.";
    if (!payload.customer.phone) return "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω.";
    if (payload.deliveryType === "delivery"){
      if (!payload.customer.address) return "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.";
      // urgent availability
      if (payload.urgent && !selectedZone().urgent) return "–°—Ä–æ—á–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —ç—Ç–æ–π –∑–æ–Ω–µ.";
    }
    return "";
  }

  // ===== Send order =====
  document.getElementById("submitOrder").addEventListener("click", ()=>{
    const payload = makeOrderPayload();
    const err = validate(payload);
    if (err){
      if (tg?.showPopup){
        tg.showPopup({ title:"–û—à–∏–±–∫–∞", message: err, buttons:[{type:"ok"}] });
      } else {
        alert(err);
      }
      return;
    }

    // Save profile defaults
    const p = loadProfile();
    const nextProfile = {
      name: payload.customer.name || p.name || "",
      phone: payload.customer.phone || p.phone || "",
      addresses: (()=> {
        const addr = payload.customer.address ? [payload.customer.address] : [];
        const old = p.addresses || [];
        const merged = [...new Set([...addr, ...old])].slice(0,5);
        return merged;
      })(),
      recipients: (()=> {
        const r = payload.customer.recipient ? [payload.customer.recipient] : [];
        const old = p.recipients || [];
        const merged = [...new Set([...r, ...old])].slice(0,8);
        return merged;
      })(),
    };
    saveProfileObj(nextProfile);

    try{
      const data = JSON.stringify(payload);
      tg?.sendData(data);

      // UX reset
      cart.clear();
      syncUI();
      renderCart();

      if (tg?.showPopup){
        tg.showPopup({
          title:"‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
          message:"–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∏—à–ª—ë–º —Å—Ç–∞—Ç—É—Å.",
          buttons:[{type:"ok"}]
        });
      } else {
        alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
      }

      closeDrawer();
    }catch(e){
      console.error(e);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    }
  });

  // ===== Init filters chips =====
  function initFiltersUI(){
    renderChips("colorChips", uniqueValues("colors"), filters.colors);
    renderChips("occasionChips", uniqueValues("occasion"), filters.occasions);
    renderChips("recipientChips", uniqueValues("recipient"), filters.recipients);
  }

  // ===== Hooks =====
  document.getElementById("openCart").addEventListener("click", openDrawer);
  document.getElementById("openCart2").addEventListener("click", openDrawer);
  document.getElementById("closeDrawer").addEventListener("click", closeDrawer);

  // ===== Start =====
  initZones();
  initSlots();
  initFiltersUI();
  renderStories();
  renderGrid();
  syncUI();

  // Pre-fill from profile
  renderProfileUI();
</script>
</body>
</html>
