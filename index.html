<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>FLORA ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#fbfbfd;
      --card:#ffffff;
      --text:#141414;
      --muted:#6b6b6b;
      --brand:#2aa36b;
      --brand2:#1e7b52;
      --line:rgba(0,0,0,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#ffffff,var(--bg));
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 92px}
    .top{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);border-radius:var(--r);
      background:rgba(255,255,255,.9);backdrop-filter:blur(8px);
      position:sticky;top:10px;z-index:10;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px
    }
    .brand b{font-size:16px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      display:flex;gap:8px;align-items:center;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .pill b{font-size:13px}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media (min-width:760px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;flex-direction:column;
      min-height:240px;
    }
    .img{
      height:140px;
      background:linear-gradient(135deg, rgba(42,163,107,.15), rgba(30,123,82,.10));
      display:flex;align-items:center;justify-content:center;
      font-size:42px;
    }
    .cbody{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:800;line-height:1.15}
    .desc{font-size:12px;color:var(--muted);min-height:34px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .price{font-weight:900}
    .btn{
      border:none;border-radius:12px;
      padding:10px 10px;
      font-weight:800;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:#fff;color:var(--brand2);
      border:1px solid rgba(42,163,107,.35);
    }

    /* Drawer */
    .drawer{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;
      border-top:1px solid var(--line);
      border-radius:18px 18px 0 0;
      box-shadow:0 -18px 50px rgba(0,0,0,.10);
      transform:translateY(110%);
      transition:.25s ease;
      z-index:50;
    }
    .drawer.open{transform:translateY(0)}
    .dhead{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dhead b{font-size:16px}
    .close{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--line);background:#fff;cursor:pointer;
      font-size:18px;
    }
    .dcontent{padding:0 14px 14px}
    .cartitem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 0;border-bottom:1px solid var(--line);
    }
    .cartitem:last-child{border-bottom:none}
    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:999px;padding:6px 8px;
    }
    .qbtn{
      width:28px;height:28px;border-radius:10px;border:none;
      cursor:pointer;font-weight:900;
      background:rgba(42,163,107,.12);color:var(--brand2);
    }
    .muted{color:var(--muted);font-size:12px}
    .form{
      margin-top:12px;
      display:grid;grid-template-columns:1fr;gap:10px;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:10px;border:1px solid var(--line);border-radius:14px;
      background:#fff;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input,.field textarea{
      border:none;outline:none;font-size:14px;
      font-family:inherit;
      resize:none;
    }
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 14px;
      background:rgba(255,255,255,.92);
      border-top:1px solid var(--line);
      backdrop-filter:blur(10px);
      z-index:40;
    }
    .footerbar .bar{
      max-width:980px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .tot{display:flex;flex-direction:column;gap:2px}
    .tot b{font-size:14px}
    .tot span{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>FLORA Samarkand</b>
        <span>–ö–∞—Ç–∞–ª–æ–≥ –±—É–∫–µ—Ç–æ–≤ ‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ ‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span>
      </div>
      <div class="pill" id="openCart">
        üõí <b id="cartCount">0</b>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="footerbar">
    <div class="bar">
      <div class="tot">
        <b id="totalText">–ò—Ç–æ–≥–æ: 0 UZS</b>
        <span>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ</span>
      </div>
      <button class="btn" id="openCart2">–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <div class="dhead">
      <b>üõí –ö–æ—Ä–∑–∏–Ω–∞</b>
      <button class="close" id="closeDrawer">‚úï</button>
    </div>
    <div class="dcontent">
      <div id="cartList"></div>

      <div class="row" style="margin-top:10px">
        <div class="muted">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞</div>
        <div class="price" id="drawerTotal">0 UZS</div>
      </div>

      <div class="form">
        <div class="field">
          <label>–ò–º—è</label>
          <input id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∞–ª–µ—Ä" />
        </div>
        <div class="field">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phone" placeholder="+998 __ ___ __ __" />
        </div>
        <div class="field">
          <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input id="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –æ—Ä–∏–µ–Ω—Ç–∏—Ä" />
        </div>
        <div class="row" style="gap:10px">
          <div class="field" style="flex:1">
            <label>–î–∞—Ç–∞</label>
            <input id="date" placeholder="–ù–∞–ø—Ä: 29.01" />
          </div>
          <div class="field" style="flex:1">
            <label>–í—Ä–µ–º—è</label>
            <input id="time" placeholder="–ù–∞–ø—Ä: 19:30" />
          </div>
        </div>
        <div class="field">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <textarea id="comment" rows="3" placeholder="–¶–≤–µ—Ç —É–ø–∞–∫–æ–≤–∫–∏, —Ç–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏ –∏ —Ç.–¥."></textarea>
        </div>

        <button class="btn" id="submitOrder">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button class="btn secondary" id="clearCart">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>

        <div class="muted" style="padding-top:4px">
          –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ –±–æ—Ç. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== Telegram WebApp init =====
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    tg.ready();
  }

  // ===== Demo catalog (–∑–∞–º–µ–Ω–∏—à—å –Ω–∞ —Å–≤–æ–π) =====
  const CURRENCY = "UZS";
  const PRODUCTS = [
    { id:"rose_25", emoji:"üåπ", title:"25 –∫—Ä–∞—Å–Ω—ã—Ö —Ä–æ–∑", desc:"–ö–ª–∞—Å—Å–∏–∫–∞ –¥–ª—è –æ—Å–æ–±–æ–≥–æ —Å–ª—É—á–∞—è", price:350000 },
    { id:"mix_pastel", emoji:"üíê", title:"–ù–µ–∂–Ω—ã–π –º–∏–∫—Å (–ø–∞—Å—Ç–µ–ª—å)", desc:"–°–±–æ—Ä–Ω—ã–π –±—É–∫–µ—Ç, –ª—ë–≥–∫–∏–π –∏ –≤–æ–∑–¥—É—à–Ω—ã–π", price:280000 },
    { id:"tulip_21", emoji:"üå∑", title:"21 —Ç—é–ª—å–ø–∞–Ω", desc:"–ò–¥–µ–∞–ª—å–Ω–æ –Ω–∞ –≤–µ—Å–Ω—É –∏ —Å–≤–∏–¥–∞–Ω–∏–µ", price:240000 },
    { id:"premium_box", emoji:"üéÅ", title:"–ü—Ä–µ–º–∏—É–º –≤ –∫–æ—Ä–æ–±–∫–µ", desc:"–ö–æ–º–ø–æ–∑–∏—Ü–∏—è –≤ —à–ª—è–ø–Ω–æ–π –∫–æ—Ä–æ–±–∫–µ", price:490000 },
    { id:"wedding", emoji:"üíç", title:"–°–≤–∞–¥–µ–±–Ω—ã–π –±—É–∫–µ—Ç", desc:"–ü–æ–¥–±–æ—Ä –ø–æ–¥ –ø–ª–∞—Ç—å–µ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é", price:550000 },
    { id:"corporate", emoji:"üè¢", title:"–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è", desc:"–û—Ñ–∏—Å / —Ä–µ—Å–µ–ø—à–Ω / –ø–æ–¥–∞—Ä–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º", price:420000 },
  ];

  // ===== State =====
  const cart = new Map(); // id -> qty

  const grid = document.getElementById("grid");
  const drawer = document.getElementById("drawer");
  const cartList = document.getElementById("cartList");
  const cartCount = document.getElementById("cartCount");
  const totalText = document.getElementById("totalText");
  const drawerTotal = document.getElementById("drawerTotal");

  function money(n){
    return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  function getTotal(){
    let total = 0;
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x=>x.id===id);
      if (p) total += p.price * qty;
    }
    return total;
  }

  function renderGrid(){
    grid.innerHTML = "";
    PRODUCTS.forEach(p=>{
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="img">${p.emoji}</div>
        <div class="cbody">
          <div class="title">${p.title}</div>
          <div class="desc">${p.desc}</div>
          <div class="row">
            <div class="price">${money(p.price)} ${CURRENCY}</div>
            <button class="btn" data-id="${p.id}">‚ûï –í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;
      grid.appendChild(el);
    });

    grid.querySelectorAll("button[data-id]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.id;
        cart.set(id, (cart.get(id)||0) + 1);
        syncUI();
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
      });
    });
  }

  function renderCart(){
    const items = [...cart.entries()];
    if (items.length === 0){
      cartList.innerHTML = `<div class="muted">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –±—É–∫–µ—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ üå∏</div>`;
      return;
    }

    cartList.innerHTML = "";
    items.forEach(([id, qty])=>{
      const p = PRODUCTS.find(x=>x.id===id);
      if (!p) return;

      const row = document.createElement("div");
      row.className = "cartitem";
      row.innerHTML = `
        <div>
          <div style="font-weight:900">${p.emoji} ${p.title}</div>
          <div class="muted">${money(p.price)} ${CURRENCY} –∑–∞ 1 —à—Ç</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="qty">
            <button class="qbtn" data-act="minus" data-id="${id}">‚àí</button>
            <b>${qty}</b>
            <button class="qbtn" data-act="plus" data-id="${id}">+</button>
          </div>
        </div>
      `;
      cartList.appendChild(row);
    });

    cartList.querySelectorAll("button[data-act]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.dataset.id;
        const act = b.dataset.act;
        const cur = cart.get(id) || 0;
        if (act === "plus") cart.set(id, cur + 1);
        if (act === "minus"){
          const next = cur - 1;
          if (next <= 0) cart.delete(id);
          else cart.set(id, next);
        }
        syncUI();
        renderCart();
      });
    });
  }

  function syncUI(){
    const count = [...cart.values()].reduce((a,b)=>a+b,0);
    cartCount.textContent = count;
    const total = getTotal();
    totalText.textContent = `–ò—Ç–æ–≥–æ: ${money(total)} ${CURRENCY}`;
    drawerTotal.textContent = `${money(total)} ${CURRENCY}`;
  }

  function openDrawer(){
    drawer.classList.add("open");
    renderCart();
    syncUI();
  }
  function closeDrawer(){
    drawer.classList.remove("open");
  }

  document.getElementById("openCart").addEventListener("click", openDrawer);
  document.getElementById("openCart2").addEventListener("click", openDrawer);
  document.getElementById("closeDrawer").addEventListener("click", closeDrawer);

  document.getElementById("clearCart").addEventListener("click", ()=>{
    cart.clear();
    syncUI();
    renderCart();
  });

  function makeOrderPayload(){
    const items = [];
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x=>x.id===id);
      if (!p) continue;
      items.push({ id:p.id, title:p.title, qty, price:p.price });
    }

    const now = new Date();
    const orderId = "FL-" + now.getFullYear().toString().slice(2) +
      String(now.getMonth()+1).padStart(2,"0") +
      String(now.getDate()).padStart(2,"0") + "-" +
      String(now.getHours()).padStart(2,"0") +
      String(now.getMinutes()).padStart(2,"0") +
      String(Math.floor(Math.random()*90+10));

    return {
      type: "order",
      orderId,
      createdAt: now.toISOString(),
      customer: {
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        date: document.getElementById("date").value.trim(),
        time: document.getElementById("time").value.trim(),
        comment: document.getElementById("comment").value.trim(),
      },
      items,
      total: getTotal(),
      currency: CURRENCY
    };
  }

  function validate(payload){
    if (!payload.items.length) return "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.";
    if (!payload.customer.name) return "–í–≤–µ–¥–∏—Ç–µ –∏–º—è.";
    if (!payload.customer.phone) return "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω.";
    if (!payload.customer.address) return "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.";
    return "";
  }

  document.getElementById("submitOrder").addEventListener("click", ()=>{
    const payload = makeOrderPayload();
    const err = validate(payload);
    if (err){
      if (tg?.showPopup){
        tg.showPopup({ title:"–û—à–∏–±–∫–∞", message: err, buttons:[{type:"ok"}] });
      } else {
        alert(err);
      }
      return;
    }

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç
    try{
      const data = JSON.stringify(payload);
      tg?.sendData(data);

      // UX
      cart.clear();
      syncUI();
      renderCart();

      if (tg?.showPopup){
        tg.showPopup({
          title:"‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
          message:"–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
          buttons:[{type:"ok"}]
        });
      } else {
        alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
      }

      // –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å WebApp –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞:
      // tg?.close();
    }catch(e){
      console.error(e);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    }
  });

  renderGrid();
  syncUI();
</script>
</body>
</html>
